name: Quality Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Pre-Push Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Basic validation
        run: |
          echo "Checking for common issues..."
          for f in CLAUDE.md .coderabbit.yaml greptile.json; do
            if [ -f "$f" ]; then
              echo "âœ“ $f exists"
            else
              echo "::warning::Missing $f"
            fi
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Check for merge conflict markers
        run: |
          if grep -rn "<<<<<<< \|======= \|>>>>>>> " --include="*.md" --include="*.py" --include="*.json" . 2>/dev/null; then
            echo "::error::Merge conflict markers found"
            exit 1
          fi
          echo "No merge conflict markers found"

  docs-audit:
    name: Documentation Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check documentation freshness
        run: |
          echo "Checking documentation freshness..."
          CUTOFF_DATE=$(date -d "30 days ago" +%s 2>/dev/null || date -v-30d +%s)
          STALE_DOCS=0
          for file in $(git ls-files "*.md"); do
            LAST_COMMIT=$(git log -1 --format=%ct -- "$file" 2>/dev/null || echo "0")
            if [ "$LAST_COMMIT" -lt "$CUTOFF_DATE" ]; then
              STALE_DOCS=$((STALE_DOCS + 1))
            fi
          done
          echo "Found $STALE_DOCS markdown files not updated in 30+ days"
          if [ "$STALE_DOCS" -gt 5 ]; then
            echo "::warning::Found $STALE_DOCS potentially stale documentation files"
          fi

  gitleaks:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate JSON/YAML
        uses: GrantBirki/json-yaml-validate@v3

      - name: Lint GitHub Actions workflows
        uses: docker://rhysd/actionlint:latest
        with:
          args: -color

  editorconfig-check:
    name: EditorConfig
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check EditorConfig
        uses: editorconfig-checker/action-editorconfig-checker@main

  license-review:
    name: License Compliance
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check dependency licenses
        uses: actions/dependency-review-action@v4
        with:
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD, Unlicense, WTFPL, CC0-1.0, CC-BY-3.0, CC-BY-4.0, Python-2.0, PSF-2.0, MPL-2.0

