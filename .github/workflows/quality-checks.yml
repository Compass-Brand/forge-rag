name: Quality Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Pre-Push Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Basic validation
        run: |
          echo "Checking for common issues..."
          for f in CLAUDE.md .coderabbit.yaml greptile.json; do
            if [ -f "$f" ]; then
              echo "âœ“ $f exists"
            else
              echo "::warning::Missing $f"
            fi
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for merge conflict markers
        run: |
          # Use anchored patterns to avoid false positives
          if grep -rn "^<<<<<<<\|^=======\$\|^>>>>>>>" --include="*.md" --include="*.py" --include="*.ts" --include="*.js" --include="*.json" . 2>/dev/null; then
            echo "::error::Merge conflict markers found"
            exit 1
          fi
          echo "No merge conflict markers found"

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          FOUND=0
          # Check for common secret patterns
          if grep -rn "PRIVATE.KEY\|-----BEGIN.*PRIVATE\|sk-[a-zA-Z0-9]\{20,\}\|ghp_[a-zA-Z0-9]\{36\}\|gho_[a-zA-Z0-9]\{36\}\|api[_-]?key.*['\"][a-zA-Z0-9]\{20,\}" --include="*.py" --include="*.ts" --include="*.js" --include="*.json" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v node_modules | grep -v ".example" | head -10; then
            echo "::warning::Potential hardcoded secrets detected - please review"
            FOUND=1
          fi
          # Check for AWS keys (exclude test fixtures and examples)
          if grep -rn "AKIA[0-9A-Z]\{16\}" --include="*.py" --include="*.ts" --include="*.js" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v "test" | grep -v "example" | grep -v "fixture" | grep -v ".github/" | head -5; then
            echo "::warning::AWS access key pattern found - please review"
            FOUND=1
          fi
          if [ "$FOUND" -eq 1 ]; then
            echo "::warning::Secret patterns detected - review findings above"
          fi
          echo "Secret scan complete"

  docs-audit:
    name: Documentation Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check documentation freshness
        run: |
          echo "Checking documentation freshness..."
          CUTOFF_DATE=$(date -d "30 days ago" +%s 2>/dev/null || date -v-30d +%s)
          STALE_DOCS=0
          for file in $(git ls-files "*.md"); do
            LAST_COMMIT=$(git log -1 --format=%ct -- "$file" 2>/dev/null || echo "0")
            if [ "$LAST_COMMIT" -lt "$CUTOFF_DATE" ]; then
              STALE_DOCS=$((STALE_DOCS + 1))
            fi
          done
          echo "Found $STALE_DOCS markdown files not updated in 30+ days"
          if [ "$STALE_DOCS" -gt 5 ]; then
            echo "::warning::Found $STALE_DOCS potentially stale documentation files"
          fi

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate JSON/YAML
        uses: GrantBirki/json-yaml-validate@v4
        continue-on-error: true  # May fail on template files or non-standard formats

      - name: Lint GitHub Actions workflows
        uses: docker://rhysd/actionlint:latest
        with:
          args: -color
        continue-on-error: true  # May flag pre-existing issues in other workflows

  editorconfig-check:
    name: EditorConfig
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check EditorConfig
        uses: editorconfig-checker/action-editorconfig-checker@main

  license-review:
    name: License Compliance
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check dependency licenses
        uses: actions/dependency-review-action@v4
        continue-on-error: true  # Requires GHAS on private repos; non-blocking fallback
        with:
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD, Unlicense, WTFPL, CC0-1.0, CC-BY-3.0, CC-BY-4.0, Python-2.0, PSF-2.0, MPL-2.0

  python-lint:
    name: Python Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for Python files
        id: check-python
        run: |
          if find . -name "*.py" -not -path "./node_modules/*" -not -path "./.venv/*" | head -1 | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.has_python == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install Ruff
        if: steps.check-python.outputs.has_python == 'true'
        run: pip install ruff

      - name: Run Ruff linter
        if: steps.check-python.outputs.has_python == 'true'
        run: ruff check . --output-format=github
        continue-on-error: true

      - name: Run Ruff formatter check
        if: steps.check-python.outputs.has_python == 'true'
        run: ruff format --check .
        continue-on-error: true

  js-lint:
    name: JavaScript/TypeScript Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for JS/TS files
        id: check-js
        run: |
          if find . -name "*.js" -o -name "*.ts" -o -name "*.mjs" -o -name "*.tsx" -o -name "*.jsx" 2>/dev/null | grep -v node_modules | head -1 | grep -q .; then
            echo "has_js=true" >> $GITHUB_OUTPUT
          else
            echo "has_js=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check-js.outputs.has_js == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install linters
        if: steps.check-js.outputs.has_js == 'true'
        run: npm install -g eslint prettier

      - name: Run ESLint
        if: steps.check-js.outputs.has_js == 'true'
        run: eslint . --ext .js,.ts,.mjs,.jsx,.tsx --format=stylish --ignore-pattern node_modules/
        continue-on-error: true

      - name: Run Prettier check
        if: steps.check-js.outputs.has_js == 'true'
        run: prettier --check "**/*.{js,ts,mjs,jsx,tsx,json}" --ignore-path .gitignore
        continue-on-error: true

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: "**/*.md"
        continue-on-error: true

